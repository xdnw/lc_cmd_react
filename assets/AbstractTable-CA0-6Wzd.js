import{r as e,j as s,L as t,u as r}from"./index-C3E2-SUH.js";import{X as o,T as a,I as l}from"./queries-BuM6HYrb.js";import{B as n}from"./button-DCZsNPnk.js";import{u as i,a as c}from"./DialogContext-BJx4vabV.js";import{g as u,t as d,h as m}from"./table_util-C8W_dWTS.js";import{u as h}from"./useSuspenseQuery-DiLOpIi1.js";import{G as p,D as b}from"./DataTable-CCFIBfma.js";import{a as g}from"./StateUtil-CGhFEjjS.js";import{L as f}from"./loading-CI11-4Uh.js";function j({getTableProps:t,load:r}){const o=e.useRef(null),{showDialog:a}=i(),[l,c]=g(r?t().type:null),[d,m]=g(r?t().selection:{}),[h,f]=g(r?t().columns:new Map),[j,w]=g(r?t().sort:void 0),y=e.useCallback((()=>{const e=t();return c(e.type),m(e.selection),f(e.columns),w(e.sort),e}),[t,c,m,f,w]),C=e.useCallback(((e,s)=>{var t;const r=null==(t=o.current)?void 0:t.element,a=(null==r?void 0:r.querySelectorAll(".bg-red-500"))||[];for(const o of a)o.classList.remove("bg-red-500")}),[o]),S=e.useCallback((()=>{const e=`${window.location.protocol+"//"+window.location.host}/#/view_table?${encodeURIComponent(u({type:l,selAndModifiers:d,columns:h,sort:j}))}`;navigator.clipboard.writeText(e).then((()=>{a("URL copied to clipboard",e,!0)})).catch((e=>{a("Failed to copy URL to clipboard",e+"",!0)}))}),[l,d,h,j,a]),k=e.useMemo((()=>l&&d&&h?s.jsx(p,{type:l,selection:d,columns:h}):null),[l,d,h]),N=e.useMemo((()=>s.jsx(n,{variant:"outline",size:"sm",onClick:S,children:"Share"})),[S]),E=e.useCallback((e=>{const s=parseInt(e.currentTarget.dataset.col??"0")-1,t=parseInt(e.currentTarget.dataset.row??"0")-1;C(s,t)}),[C]),M=e.useCallback((e=>{const t=e.length>0?"Errors updating table":"No errors",r=e.length>0?s.jsxs(s.Fragment,{children:["Errors updating the table may prevent some data from being displayed. Click the buttons below to highlight the errors in the table.",e.map(((e,t)=>s.jsxs(n,{"data-col":e.col,"data-row":e.row,variant:"destructive",className:"my-1 h-auto break-words w-full justify-start size-sm whitespace-normal",onClick:E,children:["[col:",(e.col??0)+1,e.row?`row:${e.row+1}`:"","] ",e.msg]},t)))]}):"No errors";a(t,r)}),[a,E]),T=e.useCallback(((e,t,r,a,l,n,i)=>s.jsxs(s.Fragment,{children:[k,N,e,s.jsx(b,{table:o,data:t,columnsInfo:r,sort:j,searchSet:a,visibleColumns:l,showExports:!0,setColumns:n,setData:i,setSort:w})]})),[k,N,j,w]);return r?s.jsx(v,{type:l,selection:d,columns:h,sort:j,showErrorsProvided:M,children:T}):s.jsx(x,{table:o,getTableProps:y,setSortState:w,showErrorsProvided:M,children:T})}function v({type:r,selection:l,columns:c,sort:p,showErrorsProvided:b,children:g}){const{showDialog:f}=i(),j=e.useMemo((()=>({...o(a.endpoint,{type:r,selection_str:d(l),columns:Array.from(c.keys())},void 0,10),enabled:!1})),[r,l,c]),{data:v}=h(j),[x,w]=e.useState([]),[y,C]=e.useState(new Set),S=v.data,k=e.useMemo((()=>{try{return m(S,p,c)}catch(e){return}}),[p,c,S]),[N,E]=e.useState(null==k?void 0:k.data),[M,T]=e.useState((null==k?void 0:k.columnsInfo)||[]),[I,z]=e.useState((null==k?void 0:k.errors)||[]);if(v.error)return s.jsxs("div",{className:"text-red-500",children:["Error: ",v.error]});if(!v.data)return s.jsx("div",{className:"text-red-500",children:"No data"});if(!k)return s.jsx("div",{className:"text-red-500",children:"Error: No data"});const A=e.useCallback((()=>{I.length>0?b(I):f("No errors","No errors to display",!0)}),[I,b,f]),D=e.useMemo((()=>`/custom_table?${u({type:r,selAndModifiers:l,columns:c,sort:p})}`),[r,l,c,p]),F=e.useMemo((()=>s.jsxs(n,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==I.length?"hidden":""),onClick:A,children:["View ",I.length," Errors"]})),[I.length,A]);return s.jsxs(s.Fragment,{children:[s.jsx(n,{variant:"outline",size:"sm",className:"me-1",asChild:!0,children:s.jsx(t,{to:D,children:"Edit Table"})}),g(F,N,M,y,x,T,E)]})}function x({table:t,getTableProps:o,setSortState:u,showErrorsProvided:h,children:p}){const{showDialog:b}=i(),g=r(),[j,v]=e.useState([]),[x,w]=e.useState([]),[y,C]=e.useState(new Set),[S,k]=e.useState([]),[N,E]=e.useState([]),[M,T]=e.useState(!1),I=e.useCallback((()=>{N.length>0?h(N):b("No errors","No errors to display",!0)}),[N,h,b]),z=e.useCallback((e=>{v(e.data),k(e.columnsInfo),w(e.visibleColumns),C(e.searchSet),E(e.errors),u(e.sort)}),[v,k,w,C,E,u]),A=e.useMemo((()=>s.jsxs(n,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==N.length?"hidden":""),onClick:I,children:["View ",N.length," Errors"]})),[N.length,I]),D=e.useCallback((e=>{const t=e instanceof Error?s.jsxs(s.Fragment,{children:[e.message,s.jsx(c,{text:e.stack+""})]}):e+"";b("Failed to update table",t,!0)}),[b]),F=e.useCallback(((e,s,t)=>{try{const r=m(e,s,t);z(r)}catch(r){D(r)}}),[z,D]),P=e.useCallback((()=>{const{type:e,selection:s,columns:t,sort:r}=o(),n={type:e,selection_str:d(s),columns:Array.from(t.keys())};T(!0),g.fetchQuery(l(a.endpoint,n,0)).then((({data:e})=>{e?F(e,r,t):D("No data returned from server")})).catch((e=>{D(e)})).finally((()=>{T(!1)}))}),[o,F,g,D]),L="Generate Table",R=e.useMemo((()=>s.jsx(n,{variant:"destructive",size:"sm",className:"me-1 relative",onClick:P,disabled:M,children:s.jsxs("span",{className:"flex items-center justify-center w-full",children:[s.jsx("span",{className:M?"invisible":"visible",children:L}),M&&s.jsx("span",{className:"absolute inset-0 flex items-center justify-center",children:s.jsx(f,{size:3,variant:"ripple"})})]})})),[M,P,L]);return s.jsxs(s.Fragment,{children:[R,p(A,j,S,y,x,k,v)]})}export{j as A};
