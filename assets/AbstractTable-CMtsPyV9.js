import{r as e,j as s,L as t,u as r}from"./index-CB60MK8B.js";import{Y as o,T as a,J as l,a as n}from"./loading-Cq9Kwdp4.js";import{B as i}from"./button-Dc6LF0a5.js";import{u as c,a as u}from"./DialogContext-Ddeg3-RV.js";import{g as d,t as m,h}from"./table_util-YFgifY52.js";import{u as p}from"./useSuspenseQuery-BSBlP-_p.js";import{G as b,D as g}from"./DataTable-DYj0ofQC.js";import{a as f}from"./StateUtil-BfNeAsTQ.js";function j({getTableProps:t,load:r}){const o=e.useRef(null),{showDialog:a}=c(),[l,n]=f(r?t().type:null),[u,m]=f(r?t().selection:{}),[h,p]=f(r?t().columns:new Map),[j,w]=f(r?t().sort:void 0),y=e.useCallback((()=>{const e=t();return n(e.type),m(e.selection),p(e.columns),w(e.sort),e}),[t,n,m,p,w]),C=e.useCallback(((e,s)=>{var t;const r=null==(t=o.current)?void 0:t.element,a=(null==r?void 0:r.querySelectorAll(".bg-red-500"))||[];for(const o of a)o.classList.remove("bg-red-500")}),[o]),S=e.useCallback((()=>{const e=`${window.location.protocol+"//"+window.location.host}/#/view_table?${encodeURIComponent(d({type:l,selAndModifiers:u,columns:h,sort:j}))}`;navigator.clipboard.writeText(e).then((()=>{a("URL copied to clipboard",e,!0)})).catch((e=>{a("Failed to copy URL to clipboard",e+"",!0)}))}),[l,u,h,j,a]),k=e.useMemo((()=>l&&u&&h?s.jsx(b,{type:l,selection:u,columns:h}):null),[l,u,h]),N=e.useMemo((()=>s.jsx(i,{variant:"outline",size:"sm",onClick:S,children:"Share"})),[S]),E=e.useCallback((e=>{const s=parseInt(e.currentTarget.dataset.col??"0")-1,t=parseInt(e.currentTarget.dataset.row??"0")-1;C(s,t)}),[C]),M=e.useCallback((e=>{const t=e.length>0?"Errors updating table":"No errors",r=e.length>0?s.jsxs(s.Fragment,{children:["Errors updating the table may prevent some data from being displayed. Click the buttons below to highlight the errors in the table.",e.map(((e,t)=>s.jsxs(i,{"data-col":e.col,"data-row":e.row,variant:"destructive",className:"my-1 h-auto break-words w-full justify-start size-sm whitespace-normal",onClick:E,children:["[col:",(e.col??0)+1,e.row?`row:${e.row+1}`:"","] ",e.msg]},t)))]}):"No errors";a(t,r)}),[a,E]),T=e.useCallback(((e,t,r,a,l,n,i)=>s.jsxs(s.Fragment,{children:[k,N,e,s.jsx(g,{table:o,data:t,columnsInfo:r,sort:j,searchSet:a,visibleColumns:l,showExports:!0,setColumns:n,setData:i,setSort:w})]})),[k,N,j,w]);return r?s.jsx(v,{type:l,selection:u,columns:h,sort:j,showErrorsProvided:M,children:T}):s.jsx(x,{table:o,getTableProps:y,setSortState:w,showErrorsProvided:M,children:T})}function v({type:r,selection:l,columns:n,sort:u,showErrorsProvided:b,children:g}){const{showDialog:f}=c(),j=e.useMemo((()=>({...o(a.endpoint,{type:r,selection_str:m(l),columns:Array.from(n.keys())},void 0,10),enabled:!1})),[r,l,n]),{data:v}=p(j),[x,w]=e.useState([]),[y,C]=e.useState(new Set),S=v.data,k=e.useMemo((()=>{try{return h(S,u,n)}catch(e){return}}),[u,n,S]),[N,E]=e.useState(null==k?void 0:k.data),[M,T]=e.useState((null==k?void 0:k.columnsInfo)||[]),[z,A]=e.useState((null==k?void 0:k.errors)||[]);if(v.error)return s.jsxs("div",{className:"text-red-500",children:["Error: ",v.error]});if(!v.data)return s.jsx("div",{className:"text-red-500",children:"No data"});if(!k)return s.jsx("div",{className:"text-red-500",children:"Error: No data"});const D=e.useCallback((()=>{z.length>0?b(z):f("No errors","No errors to display",!0)}),[z,b,f]),F=e.useMemo((()=>`/custom_table?${d({type:r,selAndModifiers:l,columns:n,sort:u})}`),[r,l,n,u]),P=e.useMemo((()=>s.jsxs(i,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==z.length?"hidden":""),onClick:D,children:["View ",z.length," Errors"]})),[z.length,D]);return s.jsxs(s.Fragment,{children:[s.jsx(i,{variant:"outline",size:"sm",className:"me-1",asChild:!0,children:s.jsx(t,{to:F,children:"Edit Table"})}),g(P,N,M,y,x,T,E)]})}function x({table:t,getTableProps:o,setSortState:d,showErrorsProvided:p,children:b}){const{showDialog:g}=c(),f=r(),[j,v]=e.useState([]),[x,w]=e.useState([]),[y,C]=e.useState(new Set),[S,k]=e.useState([]),[N,E]=e.useState([]),[M,T]=e.useState(!1),z=e.useCallback((()=>{N.length>0?p(N):g("No errors","No errors to display",!0)}),[N,p,g]),A=e.useCallback((e=>{v(e.data),k(e.columnsInfo),w(e.visibleColumns),C(e.searchSet),E(e.errors),d(e.sort)}),[v,k,w,C,E,d]),D=e.useMemo((()=>s.jsxs(i,{variant:"outline",size:"sm",className:"ms-1 bg-destructive "+(0==N.length?"hidden":""),onClick:z,children:["View ",N.length," Errors"]})),[N.length,z]),F=e.useCallback((e=>{const t=e instanceof Error?s.jsxs(s.Fragment,{children:[e.message,s.jsx(u,{text:e.stack+""})]}):e+"";g("Failed to update table",t,!0)}),[g]),P=e.useCallback(((e,s,t)=>{try{const r=h(e,s,t);A(r)}catch(r){F(r)}}),[A,F]),I=e.useCallback((()=>{const{type:e,selection:s,columns:t,sort:r}=o(),n={type:e,selection_str:m(s),columns:Array.from(t.keys())};T(!0),f.fetchQuery(l(a.endpoint,n,0)).then((({data:e})=>{e?P(e,r,t):F("No data returned from server")})).catch((e=>{F(e)})).finally((()=>{T(!1)}))}),[o,P,f,F]),L="Generate Table",_=e.useMemo((()=>s.jsx(i,{variant:"destructive",size:"sm",className:"me-1 relative",onClick:I,disabled:M,children:s.jsxs("span",{className:"flex items-center justify-center w-full",children:[s.jsx("span",{className:M?"invisible":"visible",children:L}),M&&s.jsx("span",{className:"absolute inset-0 flex items-center justify-center",children:s.jsx(n,{size:3,variant:"ripple"})})]})})),[M,I,L]);return s.jsxs(s.Fragment,{children:[_,b(D,j,S,y,x,k,v)]})}export{j as A};
