import{r as e,j as s,R as t}from"./index-CB60MK8B.js";import{d as l,B as n,g as a}from"./button-Dc6LF0a5.js";import{g as r,D as o,a as i,b as c,c as d,d as u,e as m}from"./table_util-YFgifY52.js";import{K as x,c as p,a as h}from"./index.module-DJtxm5MH.js";import{k as f,u as b,L as g}from"./loading-Cq9Kwdp4.js";import{u as v,b as j,c as C,d as y,T as k,B as w}from"./DialogContext-Ddeg3-RV.js";import{C as N}from"./CommandComponent-LRDIJNlC.js";import{I as S}from"./input-B_GU0jtO.js";import{a as M}from"./StateUtil-BfNeAsTQ.js";import{A}from"./AbstractTable-CMtsPyV9.js";import"./SimpleChart-Bw3_oVsT.js";import"./theme-provider-bTdlrjsQ.js";import"./bulkwrapper-CbKbfW3U.js";import"./useSuspenseQuery-BSBlP-_p.js";import"./DataTable-DYj0ofQC.js";const T=e.forwardRef((function({defType:t,defSelection:n,defColumns:a,defSort:i},c){const{showDialog:d}=v(),[u,m]=M(t),[p,h]=M(n),[g,k]=e.useState(a),[w,N]=M(i);e.useImperativeHandle(c,(()=>({getType:()=>u,getSelection:()=>p,getColumns:()=>g,getSort:()=>w})),[u,p,g,w]);const S=e.useMemo((()=>f.getPlaceholderTypes(!1)),[]),A=e.useCallback((()=>{const e=r({type:u,selAndModifiers:p,columns:g,sort:w}),s=window.location.hash,[t]=s.split("?"),l=`${t}?${e}`;window.history.replaceState(null,"",`${window.location.pathname}${l}`)}),[u,p,g,w]);e.useEffect((()=>{A()}),[u,p,g,w,A]);const T=e.useCallback((e=>{var s,t;const n=e;m(n);const a=null==(s=o[n])?void 0:s.selections,r=null==(t=o[n])?void 0:t.columns;if(a&&Object.keys(a).length>0&&h({"":a[Object.keys(a)[0]]}),r&&Object.keys(r).length>0){const e=r[Object.keys(r)[0]];k(new Map(e.value.map((e=>Array.isArray(e)?[e[0],e[1]]:[e,null])))),N((s=>l(s,e.sort)?s:e.sort))}}),[m,h,k,N]),$=e.useCallback((e=>s.jsx(j,{value:S[e],className:"w-auto px-3",children:b(S[e])},S[e])),[S]),z=e.useMemo((()=>s.jsx(C,{className:"min-w-full",style:{overflow:"hidden"},children:s.jsx(x,{totalCount:S.length,style:{height:"40px",width:"100%"},horizontalDirection:!0,itemContent:$})})),[S,$]),E=e.useMemo((()=>s.jsx(y,{defaultValue:t,className:"w-full",onValueChange:T,children:s.jsx("div",{className:"w-full overflow-x-auto",children:z})})),[T,z,t]),R=e.useMemo((()=>s.jsx(L,{type:u,selection:p,setSelection:h,selectedTab:u})),[u,p,h]),O=e.useMemo((()=>s.jsx(D,{type:u,columns:g,setColumns:k,sort:w,setSort:N,showDialog:d})),[u,g,k,w,N,d]);return s.jsxs(s.Fragment,{children:[E,R,O]})}));function D({type:t,columns:l,setColumns:a,sort:r,setSort:i,showDialog:c}){var d;const[u,m]=e.useState(!1),[x,p]=M(Object.keys((null==(d=o[t])?void 0:d.columns)??{}));e.useEffect((()=>{var e;p(Object.keys((null==(e=o[t])?void 0:e.columns)??{}))}),[t,p]);const h=e.useRef(null),f=e.useRef(null),b=e.useCallback(((e,s)=>{const t=Array.from(l);if(s<0||s>=t.length)return;const[n]=t.splice(e,1);t.splice(s,0,n);const o=new Map(t);let c;if(Array.isArray(r))c=r.map((t=>t.idx===e?{...t,idx:s}:t.idx===s?{...t,idx:e}:t.idx>e&&t.idx<=s?{...t,idx:t.idx-1}:t.idx<e&&t.idx>=s?{...t,idx:t.idx+1}:t));else if(r){const t={...r};t.idx===e?t.idx=s:t.idx===s?t.idx=e:t.idx>e&&t.idx<=s?t.idx=t.idx-1:t.idx<e&&t.idx>=s&&(t.idx=t.idx+1),c=t}else c=void 0;a(o),i(c)}),[l,r,a,i]),v=e.useCallback((e=>{e.preventDefault();const s=e.clipboardData.getData("text").replace(/\r?\n|\r/g,"\t");if(f.current){const{selectionStart:e,selectionEnd:t,value:l}=f.current,n=l.slice(0,e)+s+l.slice(t);f.current.value=n}}),[]),j=e.useCallback((e=>{if(1===e.key.length||"Backspace"===e.key){const s=document.activeElement,t=s.id.startsWith("btn-")?s.id.split("-")[1]:"";if(!t)return;const n=s.querySelector("span"),r=e.key,o=l.get(t)||"",i=new Map(l);if("Backspace"===r){const e=o.slice(0,-1);i.set(t,e||null),n.firstChild.textContent=e.trim()?` as ${e}`:"​"}else{" "===e.key&&e.preventDefault();const s=o.trim()+r;i.set(t,s),n.firstChild.textContent=` as ${s}`}a(i)}}),[l,a]);e.useEffect((()=>(document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",j)})),[j]);const C=e.useCallback((()=>{const e=f.current;if(!e)return;const s=e.value;if(""===s)return void c("Column name cannot be empty","Please enter a column name before adding");const t=s.split("\t"),n=[],r=new Map(l);for(const l of t){if(""===l)continue;const e=l.split(";");if(!e[0])continue;let s=e[0];s.includes("{")||s.includes("}")||(s="{"+s+"}"),r.has(s)&&r.get(s)===(e[1]??null)?n.push("Column `"+l+"` is already added"):r.set(s,e[1]||null)}e.value="",n.length>0&&c("Errors adding columns",n.join("\n")),a(r)}),[l,c,a]),y=e.useCallback((e=>{var s;const l=null==(s=o[t])?void 0:s.columns[e],n=new Map(((null==l?void 0:l.value)||["{id}"]).map((e=>Array.isArray(e)?[e[0],e[1]]:[e,null]))),r=(null==l?void 0:l.sort)||{idx:0,dir:"asc"};a(n),i(r)}),[t,a,i]),k=e.useCallback(((e,s)=>{const t=new Map(l);t.delete(e[0]);let n=r;if(Array.isArray(r))n=r.filter((e=>e.idx!==s)).map((e=>({...e,idx:e.idx>s?e.idx-1:e.idx})));else if(r){const e={...r};e.idx===s?e.idx=0:e.idx>s&&(e.idx=e.idx-1),n=e}else n=void 0;a(t),i(n)}),[l,r,a,i]),w=e.useCallback(((e,s)=>{let t;if(Array.isArray(r)){const l=r.findIndex((s=>s.idx===e));if(-1!==l){const e=[...r];"asc"===e[l].dir?e[l].dir="desc":e.splice(l,1),t=e}else t=s&&r.length>0?[...r,{idx:e,dir:"asc"}]:{idx:e,dir:"asc"}}else t=r?r.idx!==e?s&&0!==r.idx?[{idx:r.idx,dir:r.dir},{idx:e,dir:"asc"}]:{idx:e,dir:"asc"}:"asc"===r.dir?{idx:e,dir:"desc"}:void 0:{idx:e,dir:"asc"};i(t)}),[r,i]),N=e.useCallback((()=>{a(new Map),i({idx:0,dir:"asc"})}),[a,i]),S=e.useCallback((e=>{const s="{"+e[0]+"}",t=new Map(l);t.set(s,null),a(t)}),[l,a]),A=e.useCallback((()=>{m((e=>!e))}),[m]),T=e.useCallback((e=>{const s=e.currentTarget.dataset.key;s&&y(s)}),[y]);return s.jsxs("div",{className:"bg-light/10 border border-light/10 rounded mt-2",children:[s.jsxs(n,{variant:"ghost",size:"md",className:"text-2xl w-full border-b border-secondary px-2 bg-primary/10 rounded-t justify-start",onClick:A,children:["Columns ",u?s.jsx(g,{name:"ChevronDown"}):s.jsx(g,{name:"ChevronUp"})]}),s.jsxs("div",{className:"transition-all duration-200 ease-in-out "+(u?"max-h-0 opacity-0 overflow-hidden":"p-2 opacity-100"),children:[s.jsx("h2",{className:"text-lg mb-1",children:"Templates"}),x.map((e=>s.jsx(n,{variant:"outline",size:"sm",className:"me-1","data-key":e,onClick:T,children:e},e))),s.jsx($,{columns:l,sort:r,moveColumn:b,removeColumn:k,handleColumnSort:w,clearAllColumns:N}),s.jsx(z,{colInputRef:f,addButton:h,handlePaste:v,handleAddColumn:C,type:t}),s.jsx(R,{type:t,columns:l,addSimpleColumn:S})]})]})}function $({columns:t,sort:l,moveColumn:a,removeColumn:r,handleColumnSort:o,clearAllColumns:i}){const c=e.useCallback((e=>{e.preventDefault(),e.currentTarget.focus()}),[]),d=e.useCallback((e=>{if(1===e.button){const s=parseInt(e.currentTarget.dataset.key||"0",10);return e.preventDefault(),o(s,e.shiftKey),!1}}),[o]),u=e.useCallback((()=>Array.from(t).map((([e,s])=>s?`${e};${s}`:e)).join("\n")),[t]),m=e.useCallback((e=>{const s=parseInt(e.currentTarget.dataset.from??"0",10),t=parseInt(e.currentTarget.dataset.to??"0",10);e.preventDefault(),s!==t&&a(s,t)}),[a]),x=e.useCallback((e=>{const s=parseInt(e.currentTarget.dataset.key??"0",10),l=e.currentTarget.dataset.column,n=[l,t.get(l)??null];e.preventDefault(),r(n,s)}),[t,r]);return s.jsxs(s.Fragment,{children:[s.jsx("h2",{className:"text-lg mt-1 pb-0 mb-0",children:"Current Columns"}),s.jsx("span",{className:"text-sm opacity-50 p-0 m-0",children:"left-click to remove | middle-click to sort | shift+middle to sort by multiple | right click and type/backspace to edit alias | clipboard button to copy"}),s.jsx("br",{}),s.jsxs("div",{className:"inline-flex flex-wrap",children:[Array.from(t).map(((e,t)=>s.jsxs("span",{className:"inline-flex items-center bg-background rounded me-1 mb-1",children:[s.jsx(g,{name:"ChevronLeft",className:"cursor-pointer w-4 h-6 rounded-s hover:bg-accent","data-from":t,"data-to":t-1,onClick:m}),s.jsxs(n,{"data-key":t,id:"btn-"+e[0],variant:"outline",size:"sm",className:"rounded-none border-r-input/50 border-l-input/50 inline-block",onContextMenu:c,"data-column":e[0],"data-index":t,onClick:x,onMouseDown:d,children:[e[0],s.jsx("span",{className:"text-xs opacity-50",children:e[1]&&e[1]!==e[0]?` as ${e[1]}`:"​"},`colspan-${t}`),l&&(Array.isArray(l)?l.map(((e,l)=>e.idx===t&&s.jsxs("span",{className:"bg-red-400 dark:bg-red-900 text-xs ml-1",children:[e.dir," (",l+1,")"]},`sort-${t}-${l}`))):l.idx===t&&s.jsx("span",{className:"bg-red-400 dark:bg-red-900 text-xs ml-1",children:l.dir},`sort-${t}`))]},e[0]),s.jsx(g,{name:"ChevronRight",className:"cursor-pointer inline-block w-4 rounded-e hover:bg-accent align-middle","data-from":t,"data-to":t+1,onClick:m})]},`spw-${t}`))),s.jsx(k,{children:s.jsx(w,{getText:u,className:"rounded [&_svg]:size-3.5 me-1",size:"sm"})}),s.jsx(n,{variant:"destructive",size:"sm",className:"rounded",onClick:i,children:"X"})]})]})}function z({colInputRef:t,addButton:l,handleAddColumn:a,handlePaste:r,type:o}){const[i,c]=e.useState(""),d=e.useRef(i);e.useEffect((()=>{d.current=i}),[i]);const u=e.useCallback((e=>{if("Enter"===e.key)e.preventDefault(),d.current&&(a(),c(""));else if("Tab"===e.key){e.preventDefault();const s=t.current;if(s){const e=s.selectionStart,t=s.selectionEnd;if(null!==e&&null!==t){const l=d.current,n=l.slice(0,e)+"\t"+l.slice(t);c(n),setTimeout((()=>{s.setSelectionRange(e+1,e+1)}),0)}}}}),[t,a]),m=e.useCallback((e=>{c(e.target.value)}),[]),x=e.useMemo((()=>s.jsxs(s.Fragment,{children:[s.jsx("h2",{className:"text-lg mt-1 mb-0 p-0",children:"Add Custom"}),s.jsx("span",{className:"text-sm opacity-50",children:"type or paste in the placeholder, then press Enter | Use tab for multiple | Use semicolon ;BLAH for column alias"})]})),[]),p=e.useMemo((()=>s.jsx(S,{type:"text",className:"relative px-1 grow",placeholder:"Custom column placeholders...",ref:t,onPaste:r,onKeyDown:u,onChange:m,value:i})),[i,t,r,u,m]),h=e.useCallback((()=>{i&&(a(),c(""))}),[i,a]),f=e.useMemo((()=>s.jsx(n,{variant:"outline",ref:l,size:"sm",className:"bg-destructive ml-2",onClick:h,children:"Add"})),[l,h]),b=e.useMemo((()=>s.jsxs("div",{className:"flex w-full",children:[p,f]})),[p,f]),g=e.useMemo((()=>s.jsxs("a",{href:`https://github.com/xdnw/locutus/wiki/${o}_placeholders`,className:"text-xs text-blue-800 dark:text-blue-400 underline hover:no-underline active:underline",target:"_blank",rel:"noreferrer",children:["View All ",o," Placeholders"]})),[o]);return s.jsxs(s.Fragment,{children:[x,b,g]})}const E=t.memo((({option:t,isHidden:l,onClick:a})=>{if(l)return null;const r=e.useCallback((()=>{a(t)}),[t,a]);return s.jsxs(n,{variant:"outline",size:"sm",className:"me-1 mb-1",onClick:r,children:[t[0],": ",s.jsx("span",{className:"text-xs opacity-50",children:t[1]})]})}));function R({type:t,columns:l,addSimpleColumn:a}){const[r,o]=e.useState(!0),c=e.useRef(null),[d,u]=e.useState(""),[m]=h(d,150),p=e.useRef(null),f=e.useMemo((()=>r?[]:i(t)),[t,r]),b=e.useMemo((()=>f.filter((([e,s])=>!m||e.toLowerCase().includes(m.toLowerCase())||s.toLowerCase().includes(m.toLowerCase())))),[f,m]),[v,j]=e.useState(0);e.useEffect((()=>{if(!r&&p.current){const e=new ResizeObserver((e=>{const{width:s}=e[0].contentRect;j(s)}));return e.observe(p.current),()=>e.disconnect()}}),[r]);const C=e.useCallback((e=>a(e)),[a]),y=e.useMemo((()=>{const e=[];for(let s=0;s<b.length;s+=15)e.push(b.slice(s,s+15));return e}),[b]),k=e.useCallback((e=>{u(e.target.value.toLowerCase())}),[]),w=e.useCallback((()=>{o((e=>!e))}),[o]),N=e.useCallback((e=>{const t=y[e];return s.jsx("div",{className:"flex flex-wrap",children:t.map(((t,n)=>{if(l.has("{"+t[0]+"}"))return null;const a=`${e}-${n}`;return s.jsx(E,{option:t,isHidden:!1,onClick:C},a)}))})}),[y,l,C]);return s.jsxs("div",{className:"bg-secondary rounded",children:[s.jsxs(n,{variant:"ghost",size:"sm",className:"text-lg w-full border-b border-secondary px-2 bg-primary/10 rounded justify-start",onClick:w,children:["Add Simple ",r?s.jsx(g,{name:"ChevronDown"}):s.jsx(g,{name:"ChevronUp"})]}),s.jsxs("div",{className:"transition-all duration-200 ease-in-out "+(r?"max-h-0 opacity-0 overflow-hidden":"px-2 pt-2 opacity-100"),children:[s.jsx("input",{ref:c,type:"text",className:"relative px-1 w-full mb-2 bg-gray-200 dark:bg-gray-600",placeholder:"Filter options",value:d,onChange:k}),s.jsxs("div",{ref:p,className:"w-full",children:[!r&&y.length>0&&s.jsx(x,{style:{height:Math.min(400,40*y.length)},totalCount:y.length,itemContent:N}),!r&&0===b.length&&s.jsx("div",{className:"py-2 text-center text-muted-foreground",children:"No matching options found"})]}),b.length>100&&s.jsxs("div",{className:"text-center text-xs text-muted-foreground",children:["Showing all ",b.length," options"]})]})]})}function L({type:t,selection:l,setSelection:a,selectedTab:r}){const[i,c]=e.useState(!1),[d,u]=e.useState(l[""]),m=e.useMemo((()=>{var e;return Object.keys((null==(e=o[t])?void 0:e.selections)??{})}),[t]);e.useEffect((()=>{u((e=>e!==l[""]?l[""]:e))}),[l,u]);const x=p((e=>{a({...l,"":e})}),150),h=e.useCallback((e=>{const s=e.target.value;u(s),x(s)}),[x]),v=e.useCallback((()=>{c((e=>!e))}),[c]),j=e.useMemo((()=>s.jsxs(n,{variant:"ghost",size:"md",className:"text-2xl w-full border-b border-secondary px-2 bg-primary/10 rounded-t justify-start",onClick:v,children:["Selection ",i?s.jsx(g,{name:"ChevronDown"}):s.jsx(g,{name:"ChevronUp"})]})),[i,v]),C=e.useCallback((e=>{var s;const n=e.currentTarget.dataset.key;if(!n)return;const r=(null==(s=o[t])?void 0:s.selections[n])||"*";u(r),a({...l,"":r})}),[t,l,a]),y=e.useMemo((()=>s.jsxs(s.Fragment,{children:[s.jsx("h2",{className:"text-lg mb-1",children:"Templates"}),m.map((e=>s.jsx(n,{variant:"outline",size:"sm",className:"me-1","data-key":e,onClick:C,children:e},e)))]})),[m,C]),N=e.useCallback((()=>d),[d]),M=e.useMemo((()=>s.jsxs(s.Fragment,{children:[s.jsx("h2",{className:"text-lg my-1",children:"Current Selection"}),s.jsxs("div",{className:"flex items-center",children:[s.jsx(S,{className:"relative px-1 w-full",type:"text",value:d,onChange:h}),s.jsx(k,{children:s.jsx(w,{getText:N,className:"rounded-[6px] [&_svg]:size-3.5 ml-2",size:"sm"})})]})]})),[d,h,N]),A=e.useMemo((()=>f.placeholders(t).getCreate()&&s.jsx(O,{modifier:f.placeholders(t).getCreate(),selection:l,setSelection:a})),[t,l,a]),T=e.useMemo((()=>s.jsxs("a",{href:`https://github.com/xdnw/locutus/wiki/${b(t)}_placeholders`,className:"text-xs text-blue-800 dark:text-blue-400 underline hover:no-underline active:underline",target:"_blank",rel:"noreferrer",children:["View All ",b(t)," Filters"]})),[t]),D=e.useMemo((()=>"transition-all duration-200 ease-in-out "+(i?"max-h-0 opacity-0 overflow-hidden":"p-2 opacity-100")),[i]);return s.jsxs("div",{className:"bg-light/10 border border-light/10 rounded mt-2",children:[j,s.jsxs("div",{className:D,children:[y,M,A,T]})]})}function O({modifier:t,selection:l,setSelection:n}){const a=e.useCallback(((e,s)=>{if(s){if(l[e]===s)return;n({...l,[e]:s})}else{if(void 0===l[e])return;const s={...l};delete s[e],n(s)}}),[l,n]),r=e.useCallback((()=>!0),[]);return s.jsx(N,{overrideName:"Modifier",command:t,filterArguments:r,initialValues:l,setOutput:a})}function I(){var t,l;const n=e.useMemo((()=>a()),[]),[r]=M(c(n)??"DBNation"),[i]=M(d(n,r)),[x]=M(u(n)??new Map(((null==(h=null==(p=o[r])?void 0:p.columns[Object.keys(o[r].columns??{})[0]])?void 0:h.value)??["{id}"]).map((e=>Array.isArray(e)?[e[0],e[1]]:[e,null]))));var p,h;const[f]=M(m(n)??(null==(l=null==(t=o[r])?void 0:t.columns[Object.keys(o[r].columns)[0]])?void 0:l.sort)),b=e.useRef(null),g=e.useCallback((()=>({type:b.current.getType(),selection:b.current.getSelection(),columns:b.current.getColumns(),sort:b.current.getSort()})),[b]),v=e.useMemo((()=>s.jsx("div",{className:"bg-light/10 border border-light/10 p-2 rounded mt-2",children:s.jsx(A,{getTableProps:g,load:!1})})),[g]);return s.jsxs(s.Fragment,{children:[s.jsx(T,{ref:b,defType:r,defSelection:i,defColumns:x,defSort:f}),v]})}export{I as default};
