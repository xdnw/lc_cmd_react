import{c as G,r as D,j as s,a as Xe,u as Ze,L as et}from"./index-SOjtd1du.js";import{u as tt}from"./SessionContext-v1NsAMUy.js";import{a as re,B as K,d as nt}from"./button-C6_F57E5.js";import{b as We,P as st,y as it,T as lt}from"./queries-BzWnpVnq.js";import{u as Ae}from"./DialogContext-DiRAa5qs.js";import{R as ot,r as rt,h as at,g as ct,c as dt,C as ut}from"./CommandComponent-Bi1lNJuB.js";import{C as Oe}from"./command-utils-BF18nFEX.js";import{c as mt}from"./StateUtil-D0CNNC7k.js";import{u as ft}from"./traditional-hdCCIUos.js";import{I as pt}from"./input-DGDhAddh.js";import{S as gt}from"./StaticTable-DbVLqxT9.js";import{u as Ke}from"./useQuery-CCK4RCGX.js";import bt from"./chevron-up-XQP-04wI.js";import ht from"./chevron-down-D7iymy_p.js";import{r as xt}from"./DataTable-CoJvVKo_.js";import"./SimpleChart-V9M2bt1B.js";import"./dropdown-menu-B_MP3PX6.js";import"./theme-provider-BQwJ-LrG.js";import"./bulkwrapper-CSppeL3K.js";import"./useSuspenseQuery-7uza5ut4.js";import"./table_util-BV1C7Yj5.js";import"./command-meta-Dt1HocaT.js";import"./AbstractTable-D8eF6Ygf.js";import"./createLucideIcon-B9ZL__uh.js";function yt(t){return{status:dt(t),message:ct(t),raw:t}}function Ct(t){const e={},n=Object.entries(t);for(const[i,l]of n)l!=null&&(e[i]=l);return e}function je(t){const e=G.c(37),{command:n,args:i,label:l,classes:o,disabled:r,showResultDialog:f,presentResult:c,onStart:a,onSuccess:j,onError:S,onComplete:I}=t,v=l===void 0?"Run":l,[g,N]=D.useState(!1),E=D.useRef(null),b=D.useRef(void 0);let A;e[0]===Symbol.for("react.memo_cache_sentinel")?(A=[],e[0]=A):A=e[0];const C=D.useRef(A),{showDialog:h}=Ae();let w,d;e[1]!==n?(d=n.join(" "),e[1]=n,e[2]=d):d=e[2],w=d;const u=w;let m,p;e[3]!==i?(p=Ct(i),e[3]=i,e[4]=p):p=e[4],m=p;const R=m;let x;e[5]!==h?(x=(Y,X)=>{const me=X?.status==="error"?"Command error":"Command result";h(me,s.jsx("div",{className:"max-h-[70vh] overflow-auto",children:s.jsx(ot,{jsonArr:Y,showDialog:h})}))},e[5]=h,e[6]=x):x=e[6];const _=x;let q;e[7]!==u||e[8]!==r||e[9]!==g||e[10]!==I||e[11]!==S||e[12]!==a||e[13]!==j||e[14]!==_||e[15]!==c||e[16]!==f||e[17]!==R?(q=()=>{g||r||(b.current=void 0,C.current=[],N(!0),a?.(),rt({command:u,values:R,onResponse:Y=>{C.current.push(Y);const X=yt(Y);b.current=X,at({json:Y,responseRef:E,showDialog:St}),X.status==="success"?j?.(X):S?.(X),c&&c(X)},onDone:()=>{N(!1),!c&&f&&C.current.length>0&&_(C.current,b.current),I?.(b.current)}}))},e[7]=u,e[8]=r,e[9]=g,e[10]=I,e[11]=S,e[12]=a,e[13]=j,e[14]=_,e[15]=c,e[16]=f,e[17]=R,e[18]=q):q=e[18];const U=q;let L;e[19]!==o?(L=re("relative",o),e[19]=o,e[20]=L):L=e[20];const J=r||g,V=g?"invisible":"visible";let H;e[21]!==v||e[22]!==V?(H=s.jsx("span",{className:V,children:v}),e[21]=v,e[22]=V,e[23]=H):H=e[23];let y;e[24]!==g?(y=g&&s.jsx("span",{className:"absolute inset-0 flex items-center justify-center",children:s.jsx(Xe,{size:3,variant:"ripple"})}),e[24]=g,e[25]=y):y=e[25];let O;e[26]!==H||e[27]!==y?(O=s.jsxs("span",{className:"flex items-center justify-center w-full",children:[H,y]}),e[26]=H,e[27]=y,e[28]=O):O=e[28];let z;e[29]!==U||e[30]!==J||e[31]!==O||e[32]!==L?(z=s.jsx(K,{variant:"outline",size:"sm",className:L,disabled:J,onClick:U,children:O}),e[29]=U,e[30]=J,e[31]=O,e[32]=L,e[33]=z):z=e[33];let Q;e[34]===Symbol.for("react.memo_cache_sentinel")?(Q=s.jsx("div",{ref:E,className:"hidden"}),e[34]=Q):Q=e[34];let Z;return e[35]!==z?(Z=s.jsxs(s.Fragment,{children:[z,Q]}),e[35]=z,e[36]=Z):Z=e[36],Z}function St(){}function Nt(t){const e=[];for(const[n,i]of Object.entries(t))if(i!=null){if(Array.isArray(i)){e.push([n,i.join(",")]);continue}e.push([n,i])}return Object.fromEntries(e)}function Ve(t){const e=G.c(27),{action:n,context:i,onSuccess:l}=t;let o,r;e[0]!==n.command?(r=Oe.get(n.command),e[0]=n.command,e[1]=r):r=e[1],o=r;const f=o;let c,a;e[2]!==n||e[3]!==i?(a=Nt(n.buildArgs(i)),e[2]=n,e[3]=i,e[4]=a):a=e[4],c=a;const j=c;let S;e[5]!==j?(S=()=>mt(j),e[5]=j,e[6]=S):S=e[6];const[I]=D.useState(S),v=At,g=wt,N=ft(I,v,nt);let E;e[7]!==I?(E=I(g),e[7]=I,e[8]=E):E=e[8];const b=E,A=vt;let C,h;e[9]!==n.id||e[10]!==l?(h=l?()=>l(n.id):void 0,e[9]=n.id,e[10]=l,e[11]=h):h=e[11],C=h;const w=C,d=n.description??"Configure command arguments and submit.";let u;e[12]!==d?(u=s.jsx("p",{className:"text-sm text-muted-foreground",children:d}),e[12]=d,e[13]=u):u=e[13];let m;e[14]!==f||e[15]!==j||e[16]!==b?(m=s.jsx("div",{className:"rounded border border-border p-2",children:s.jsx(ut,{command:f,filterArguments:A,initialValues:j,setOutput:b})}),e[14]=f,e[15]=j,e[16]=b,e[17]=m):m=e[17];const p=N,R=`Run ${n.label}`;let x;e[18]!==n.command||e[19]!==w||e[20]!==p||e[21]!==R?(x=s.jsx("div",{children:s.jsx(je,{command:n.command,args:p,label:R,classes:"!ms-0",showResultDialog:!0,onSuccess:w})}),e[18]=n.command,e[19]=w,e[20]=p,e[21]=R,e[22]=x):x=e[22];let _;return e[23]!==u||e[24]!==m||e[25]!==x?(_=s.jsxs("div",{className:"space-y-2 max-h-[70vh] overflow-auto",children:[u,m,x]}),e[23]=u,e[24]=m,e[25]=x,e[26]=_):_=e[26],_}function vt(){return!0}function wt(t){return t.setOutput}function At(t){return t.output}function jt(t){const e=G.c(35),{title:n,selectedIds:i,actions:l,canRunAction:o,onActionSuccess:r,actionLayout:f,className:c}=t,a=f===void 0?"inline":f,{showDialog:j}=Ae(),S=i.size>0;let I,v;if(e[0]!==l||e[1]!==r){v=new Map;for(const R of l)v.set(R.id,r?()=>r(R.id):void 0);e[0]=l,e[1]=r,e[2]=v}else v=e[2];I=v;const g=I;let N,E;if(e[3]!==l||e[4]!==r||e[5]!==i||e[6]!==j){E=new Map;for(const R of l)R.requiresDialog&&E.set(R.id,()=>{j(R.label,s.jsx(Ve,{action:R,context:{selectedIds:i},onSuccess:r}))});e[3]=l,e[4]=r,e[5]=i,e[6]=j,e[7]=E}else E=e[7];N=E;const b=N,A=a==="stacked"?"flex flex-wrap items-center gap-2 w-full":"flex flex-wrap items-center gap-2 ms-auto w-full sm:w-auto";let C;e[8]!==c?(C=re("mb-2",c),e[8]=c,e[9]=C):C=e[9];let h;e[10]!==n?(h=s.jsx("div",{className:"flex flex-wrap items-center gap-2",children:s.jsx("h1",{className:"text-xl font-semibold",children:n})}),e[10]=n,e[11]=h):h=e[11];const w=a==="stacked"?"mt-2":void 0;let d;e[12]!==A||e[13]!==w?(d=re(A,w),e[12]=A,e[13]=w,e[14]=d):d=e[14];let u;if(e[15]!==l||e[16]!==o||e[17]!==S||e[18]!==b||e[19]!==g||e[20]!==i){let R;e[22]!==o||e[23]!==S||e[24]!==b||e[25]!==g||e[26]!==i?(R=x=>{const q=(x.requiresSelection??!0)&&!S||!o(x),U=x.buildArgs({selectedIds:i});return x.requiresDialog?s.jsx(K,{variant:"outline",size:"sm",onClick:b.get(x.id),disabled:q,children:x.label},x.id):s.jsx(je,{command:x.command,args:U,label:x.label,classes:"!ms-0",disabled:q,showResultDialog:!0,onSuccess:g.get(x.id)},x.id)},e[22]=o,e[23]=S,e[24]=b,e[25]=g,e[26]=i,e[27]=R):R=e[27],u=l.map(R),e[15]=l,e[16]=o,e[17]=S,e[18]=b,e[19]=g,e[20]=i,e[21]=u}else u=e[21];let m;e[28]!==d||e[29]!==u?(m=s.jsx("div",{className:d,children:u}),e[28]=d,e[29]=u,e[30]=m):m=e[30];let p;return e[31]!==C||e[32]!==h||e[33]!==m?(p=s.jsxs("div",{className:C,children:[h,m]}),e[31]=C,e[32]=h,e[33]=m,e[34]=p):p=e[34],p}function Rt(t){const e=G.c(18),{id:n,isSelected:i,onToggle:l,label:o,debugTag:r,rowNumber:f}=t,c=D.useRef(!1);let a;e[0]===Symbol.for("react.memo_cache_sentinel")?(a=h=>{const w=h.nativeEvent;c.current=w.shiftKey,h.stopPropagation()},e[0]=a):a=e[0];const j=a;let S;e[1]!==n||e[2]!==l?(S=h=>{const w=c.current;l(n,w),c.current=!1,h.stopPropagation()},e[1]=n,e[2]=l,e[3]=S):S=e[3];const I=S,v=i?"text-blue-600":void 0;let g;e[4]!==v?(g=re("inline-flex items-center gap-2",v),e[4]=v,e[5]=g):g=e[5];const N=o??`Toggle selection for ${n}`,E=o??`Toggle selection for ${n}`;let b;e[6]!==r||e[7]!==i||e[8]!==I||e[9]!==N||e[10]!==E?(b=s.jsx(pt,{type:"checkbox",className:"h-4 w-4",checked:i,onMouseDown:j,onChange:I,"aria-label":N,title:E,"data-debug":r}),e[6]=r,e[7]=i,e[8]=I,e[9]=N,e[10]=E,e[11]=b):b=e[11];let A;e[12]!==f?(A=typeof f=="number"&&s.jsx("span",{className:"text-xs text-muted-foreground select-none",children:f}),e[12]=f,e[13]=A):A=e[13];let C;return e[14]!==g||e[15]!==b||e[16]!==A?(C=s.jsxs("label",{className:g,children:[b,A]}),e[14]=g,e[15]=b,e[16]=A,e[17]=C):C=e[17],C}function ze(t,e){const{showDialog:n}=Ae(),i=D.useRef(new Set),l=e?.showDialogOnError??!1,{data:o,isFetching:r,error:f}=Ke({...We(st.endpoint,{command:t.join(" ")}),retry:!1}),c=D.useMemo(()=>{if(f)return f;if(o?.error)return new Error(o.error);const a=o?.data;return a&&a.success===!1&&a.message?new Error(a.message):null},[f,o?.error,o?.data]);return D.useEffect(()=>{if(l&&c){const a=`Failed to fetch permission: ${c.message}`;if(i.current.has(a))return;i.current.add(a),n("Permission Error",a)}},[c,n,l]),{permission:o?.data??void 0,isFetching:r,error:c?c.message:void 0}}function He(t){return Array.from(t).map(e=>String(e)).sort((e,n)=>e.localeCompare(n)).join(",")}function kt(t){const e=G.c(18);let n;e[0]!==t?(n=()=>new Set(t),e[0]=t,e[1]=n):n=e[1];const[i,l]=D.useState(n);let o;e[2]!==i?(o=d=>i.has(d),e[2]=i,e[3]=o):o=e[3];const r=o;let f;e[4]===Symbol.for("react.memo_cache_sentinel")?(f=d=>{l(u=>{const m=new Set(u);return m.has(d)?m.delete(d):m.add(d),m})},e[4]=f):f=e[4];const c=f;let a;e[5]===Symbol.for("react.memo_cache_sentinel")?(a=(d,u)=>{l(m=>{const p=new Set(m);return u?p.add(d):p.delete(d),p})},e[5]=a):a=e[5];const j=a;let S;e[6]===Symbol.for("react.memo_cache_sentinel")?(S=d=>{l(u=>{const m=new Set(u);for(const p of d)m.add(p);return m})},e[6]=S):S=e[6];const I=S;let v;e[7]===Symbol.for("react.memo_cache_sentinel")?(v=d=>{l(u=>{const m=new Set(u);for(const p of d)m.delete(p);return m})},e[7]=v):v=e[7];const g=v;let N;e[8]===Symbol.for("react.memo_cache_sentinel")?(N=()=>{l(new Set)},e[8]=N):N=e[8];const E=N;let b,A;e[9]!==i?(A=Array.from(i),e[9]=i,e[10]=A):A=e[10],b=A;const C=b;let h;e[11]!==i?(h=()=>He(i),e[11]=i,e[12]=h):h=e[12];let w;return e[13]!==r||e[14]!==C||e[15]!==i||e[16]!==h?(w={selectedIds:i,list:C,count:i.size,has:r,toggle:c,setOne:j,addMany:I,removeMany:g,clear:E,setSelectedIds:l,serialize:h},e[13]=r,e[14]=C,e[15]=i,e[16]=h,e[17]=w):w=e[17],w}const It=t=>{const e=G.c(25),{children:n,content:i,className:l,hideTriggerChildrenWhenExpanded:o}=t,r=l===void 0?"":l,f=o===void 0?!1:o,[c,a]=D.useState(!1),[j,S]=D.useState(!1);let I;e[0]!==j||e[1]!==c?(I=()=>{!c&&!j&&S(!0),a(!c)},e[0]=j,e[1]=c,e[2]=I):I=e[2];const v=I;let g;e:{if(!c){g=null;break e}const R=j&&i;let x;e[3]!==R?(x=s.jsx("div",{className:"mt-1 p-3 border border-border rounded-md shadow-md bg-card w-full animate-in fade-in duration-200",children:R}),e[3]=R,e[4]=x):x=e[4],g=x}const N=g;let E,b;e[5]!==c?(b=s.jsx("span",{className:"ml-2 text-muted-foreground shrink-0",children:c?s.jsx(bt,{size:18}):s.jsx(ht,{size:18})}),e[5]=c,e[6]=b):b=e[6],E=b;const A=E;let C;e[7]!==r?(C=re("w-full cursor-pointer",r),e[7]=r,e[8]=C):C=e[8];const h=f&&c?"hidden":void 0;let w;e[9]!==h?(w=re("grow min-w-0",h),e[9]=h,e[10]=w):w=e[10];let d;e[11]!==n||e[12]!==w?(d=s.jsx("div",{className:w,children:n}),e[11]=n,e[12]=w,e[13]=d):d=e[13];let u;e[14]!==A||e[15]!==c||e[16]!==d||e[17]!==C||e[18]!==v?(u=s.jsxs(K,{variant:"outline",size:"sm",className:C,onClick:v,role:"button","aria-expanded":c,children:[d,A]}),e[14]=A,e[15]=c,e[16]=d,e[17]=C,e[18]=v,e[19]=u):u=e[19];let m;e[20]!==N?(m=N&&s.jsx("div",{className:"relative",children:N}),e[20]=N,e[21]=m):m=e[21];let p;return e[22]!==u||e[23]!==m?(p=s.jsxs("div",{className:"flex flex-col w-full",children:[u,m]}),e[22]=u,e[23]=m,e[24]=p):p=e[24],p};function Et(t,e){return t.isVisible?t.isVisible(e):!0}const Qe=[{key:"id",placeholder:{cmd:"getid",alias:"ID"}},{key:"name",placeholder:{cmd:"getname",alias:"Name"}},{key:"category",placeholder:{cmd:"getcategory",alias:"Category"}},{key:"start",placeholder:{cmd:"getstartturn",alias:"Start"},renderer:"turn_to_date"},{key:"end",placeholder:{cmd:"getendturn",alias:"End"},renderer:"turn_to_date"},{key:"wiki",placeholder:{cmd:"getwiki",alias:"Wiki"}},{key:"status",placeholder:{cmd:"getstatusdesc",alias:"Status"}},{key:"casusBelli",placeholder:{cmd:"getcasusbelli",alias:"CB"}},{key:"c1Name",placeholder:{cmd:"getcoalitionname",args:{side:"false"},alias:"C1"}},{key:"c2Name",placeholder:{cmd:"getcoalitionname",args:{side:"true"},alias:"C2"}}],Dt=Qe.reduce((t,e)=>{const n="args"in e.placeholder?e.placeholder.args:void 0,i=n?`{${e.placeholder.cmd}(${Object.entries(n).map(([l,o])=>`${l}: ${o}`).join(" ")})}`:`{${e.placeholder.cmd}}`;return t.addRaw(i,e.placeholder.alias)},Oe.placeholders("Conflict").aliased()),Ue=Qe.map((t,e)=>({...t,index:e})),_t=Object.fromEntries(Ue.map(t=>[t.key,t])),Tt=Object.fromEntries(Ue.filter(t=>typeof t.renderer=="string").map(t=>[t.placeholder.cmd,t.renderer]));function qe(t){return _t[t].index}function Me(t){const e=Number(t);return Number.isFinite(e)?e:null}function P(t,e){return t[qe(e)]}function $t(t){const e=Number(P(t,"id"));return{id:Number.isFinite(e)?e:-1,name:String(P(t,"name")??P(t,"id")??"Conflict"),category:String(P(t,"category")??""),c1Name:String(P(t,"c1Name")??""),c2Name:String(P(t,"c2Name")??""),status:String(P(t,"status")??""),wiki:String(P(t,"wiki")??""),start:Number(P(t,"start")??0),end:Number(P(t,"end")??0),casusBelli:String(P(t,"casusBelli")??""),raw:t}}function Mt(t){if(!t||typeof t!="object"||Array.isArray(t))return!1;const e=t.raw,n=t.id;return Array.isArray(e)&&Number.isFinite(Number(n))}function Ye(t,e){return e?.find(n=>n.index===qe(t))}function de(t,e,n){const i=qe(e),l=t.raw[i],o=Ye(e,n);return o?xt(l,{row:t.raw,rowIdx:0,column:o}):String(l)}function ue(t){return typeof t=="string"?t:typeof t=="number"?String(t):null}function Ot(t,e,n){const i=Ye(e,n),l=P(t.raw,e),o=i?.render?.options;if(!i?.render?.isEnum||!Array.isArray(o))return null;const r=Number(l);return Number.isNaN(r)||!o[r]?null:o[r]}function ve(t){if(!Number.isFinite(t)||t<0)return"";const n=t/12*24*60*60*1e3;return Number.isFinite(n)?`timestamp:${Math.floor(n)}`:""}function F(t,e,n){const i=Oe.get(t),l=new Set(i.getArguments().map(r=>r.name)),o={...e};return Object.entries(n).forEach(([r,f])=>{f&&l.has(r)&&(o[r]=f)}),o}const we=["conflict","sync","website"],M=["conflict","edit","rename"],k={syncWebsite:["conflict","sync","website"],createConflict:["conflict","create"],createTempConflict:["conflict","create_temp"],editWiki:["conflict","edit","wiki"],editStatus:["conflict","edit","status"],editCasusBelli:["conflict","edit","casus_belli"],editCategory:["conflict","edit","category"],editRename:["conflict","edit","rename"],editStart:["conflict","edit","start"],editEnd:["conflict","edit","end"],deleteConflict:["conflict","delete"],allianceAdd:["conflict","alliance","add"],allianceRemove:["conflict","alliance","remove"],allianceAddForNation:["conflict","alliance","add_all_for_nation"],editAddForumPost:["conflict","edit","add_forum_post"],editAddNoneWar:["conflict","edit","add_none_war"]};function B(t){if(!t)throw new Error("Conflict action requires a row context.");return t}function $(t){return{conflict:String(t.id)}}const Be=[{id:"sync-selected",label:"Bulk sync",command:k.syncWebsite,scope:"bulk",permission:we,requiresSelection:!0,buildArgs:({selectedIds:t})=>({conflicts:He(t)})},{id:"create-conflict",label:"Create conflict",command:k.createConflict,scope:"bulk",permission:M,requiresSelection:!1,requiresDialog:!0,description:"Create a new conflict with full command arguments.",buildArgs:()=>({})},{id:"create-temp-conflict",label:"Create temp",command:k.createTempConflict,scope:"bulk",permission:M,requiresSelection:!1,requiresDialog:!0,description:"Create a temporary conflict.",buildArgs:()=>({})},{id:"sync-single",label:"Sync website",description:"Run conflict sync for this conflict.",command:k.syncWebsite,scope:"row",permission:we,requiresDialog:!0,detailRole:"sync",buildArgs:({row:t})=>{const e=B(t);return{conflicts:String(e.id)}}},{id:"edit-rename",label:"Edit rename",command:k.editRename,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"name",label:"Name",order:10,value:({row:t})=>t.name},buildArgs:({row:t})=>{const e=B(t);return F(k.editRename,$(e),{name:e.name})}},{id:"edit-category",label:"Edit category",command:k.editCategory,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"category",label:"Category",order:20,value:({formatted:t})=>t.category},buildArgs:({row:t})=>{const e=B(t);return F(k.editCategory,$(e),{category:e.category})},prefillArgs:({row:t,formatted:e,columnsInfo:n})=>{const i=ue(e.category)??Ot(t,"category",n)??t.category??"";return F(k.editCategory,$(t),{category:i})}},{id:"edit-c1-name",label:"Edit C1",command:k.editRename,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"c1Name",label:"C1",order:30,value:({formatted:t})=>t.c1Name},buildArgs:({row:t})=>{const e=B(t);return F(k.editRename,$(e),{name:e.c1Name,isCoalition1:"true"})},prefillArgs:({row:t,formatted:e})=>{const n=ue(e.c1Name)??t.c1Name;return F(k.editRename,$(t),{name:n,isCoalition1:"true"})}},{id:"edit-c2-name",label:"Edit C2",command:k.editRename,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"c2Name",label:"C2",order:40,value:({formatted:t})=>t.c2Name},buildArgs:({row:t})=>{const e=B(t);return F(k.editRename,$(e),{name:e.c2Name,isCoalition2:"true"})},prefillArgs:({row:t,formatted:e})=>{const n=ue(e.c2Name)??t.c2Name;return F(k.editRename,$(t),{name:n,isCoalition2:"true"})}},{id:"edit-status",label:"Edit status",command:k.editStatus,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"status",label:"Status",order:50,expandable:!0,value:({row:t})=>t.status},buildArgs:({row:t})=>{const e=B(t);return F(k.editStatus,$(e),{status:e.status})}},{id:"edit-casus-belli",label:"Edit casus belli",command:k.editCasusBelli,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"casusBelli",label:"CB",order:60,expandable:!0,value:({row:t})=>t.casusBelli},buildArgs:({row:t})=>{const e=B(t);return F(k.editCasusBelli,$(e),{casus_belli:e.casusBelli})}},{id:"edit-wiki",label:"Edit wiki",command:k.editWiki,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"wiki",label:"Wiki",order:70,value:({row:t})=>t.wiki},buildArgs:({row:t})=>{const e=B(t);return F(k.editWiki,$(e),{url:e.wiki})}},{id:"edit-start",label:"Edit start",command:k.editStart,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"start",label:"Start",order:80,value:({formatted:t})=>t.start},buildArgs:({row:t})=>{const e=B(t);return F(k.editStart,$(e),{time:ve(e.start)})},prefillArgs:({row:t})=>F(k.editStart,$(t),{time:ve(t.start)})},{id:"edit-end",label:"Edit end",command:k.editEnd,scope:"row",permission:M,requiresDialog:!0,detailRole:"field",detailSpec:{key:"end",label:"End",order:90,value:({formatted:t})=>t.end},buildArgs:({row:t})=>{const e=B(t);return F(k.editEnd,$(e),{time:ve(e.end)})},prefillArgs:({row:t})=>F(k.editEnd,$(t),{time:ve(t.end)})},{id:"delete-conflict",label:"Delete",command:k.deleteConflict,scope:"row",permission:M,requiresDialog:!0,detailRole:"danger",buildArgs:({row:t})=>$(B(t))},{id:"alliance-add",label:"Alliance add",command:k.allianceAdd,scope:"row",permission:M,requiresDialog:!0,detailRole:"alliance-add",buildArgs:({row:t})=>$(B(t))},{id:"alliance-remove",label:"Alliance remove",command:k.allianceRemove,scope:"row",permission:M,requiresDialog:!0,detailRole:"alliance-remove-hidden",buildArgs:({row:t})=>$(B(t))},{id:"alliance-add-for-nation",label:"Add all for nation",command:k.allianceAddForNation,scope:"row",permission:M,requiresDialog:!0,detailRole:"alliance-add-for-nation",buildArgs:({row:t})=>$(B(t))},{id:"edit-add-forum-post",label:"Add forum post",command:k.editAddForumPost,scope:"row",permission:M,requiresDialog:!0,detailRole:"default",buildArgs:({row:t})=>$(B(t))},{id:"edit-add-none-war",label:"Add none war",command:k.editAddNoneWar,scope:"row",permission:M,requiresDialog:!0,detailRole:"default",buildArgs:({row:t})=>$(B(t))}];Object.fromEntries(Be.map(t=>[t.id,t]));function qt(){return Be.filter(t=>t.scope==="bulk")}function Bt(){return Be.filter(t=>t.scope==="row")}function Ft(t,e){return t.prefillArgs?{...t,buildArgs:()=>t.prefillArgs(e)}:t}function Pt(t,e){const n=[{key:"id",label:"ID",value:String(e.row.id)}],i=t.filter(l=>l.detailRole==="field"&&l.detailSpec).sort((l,o)=>(l.detailSpec?.order??0)-(o.detailSpec?.order??0));for(const l of i){const o=l.detailSpec;o&&n.push({key:o.key,label:o.label,value:o.value(e),expandable:o.expandable,action:l})}return n}function Lt(t){return t.find(e=>e.detailRole==="sync")}function zt(t){return t.find(e=>e.detailRole==="alliance-add")}function Wt(t){return t.find(e=>e.detailRole==="alliance-add-for-nation")}function Kt(t){return t.find(e=>e.detailRole==="alliance-remove-hidden")}function Vt(t){return t.filter(e=>e.detailRole==="default"||e.detailRole==="danger")}function Ht(t,e){return F(k.allianceRemove,{conflict:String(t)},{alliances:String(e)})}function Qt(t,e,n){return t===0?e||"Coalition 1":t===1?n||"Coalition 2":"Unassigned"}function Ut(t){if(!t)return[];const e=t[0]??[],n=t[1]??[],i=r=>r.filter(f=>Number.isFinite(f)&&f>0),l=[];i(e).forEach(r=>{l.push({allianceId:r,coalition:0})}),i(n).forEach(r=>{l.push({allianceId:r,coalition:1})});const o=new Map;return l.forEach(r=>{o.set(`${r.coalition}-${r.allianceId}`,r)}),Array.from(o.values())}function Yt(t){const e=G.c(13),{field:n,openAction:i,canRun:l}=t;let o;e[0]!==n.label?(o=s.jsx("span",{className:"text-xs text-muted-foreground min-w-20",children:n.label}),e[0]=n.label,e[1]=o):o=e[1];let r;e[2]!==n.expandable||e[3]!==n.value?(r=s.jsx("div",{className:"text-sm min-w-0 flex-1 overflow-hidden",children:n.expandable&&typeof n.value=="string"?s.jsx(It,{className:"!h-7 !py-0",hideTriggerChildrenWhenExpanded:!0,content:s.jsx("div",{className:"whitespace-pre-wrap break-words",children:n.value||"-"}),children:s.jsx("span",{className:"block truncate w-full text-left",children:n.value||"-"})}):s.jsx("div",{className:"whitespace-pre-wrap break-words",children:n.value||"-"})}),e[2]=n.expandable,e[3]=n.value,e[4]=r):r=e[4];let f;e[5]!==l||e[6]!==n.action||e[7]!==i?(f=n.action&&i&&s.jsx(K,{variant:"outline",size:"sm",onClick:i,disabled:!l,children:"Edit"}),e[5]=l,e[6]=n.action,e[7]=i,e[8]=f):f=e[8];let c;return e[9]!==o||e[10]!==r||e[11]!==f?(c=s.jsx("div",{className:"rounded border border-border px-2 py-1",children:s.jsxs("div",{className:"flex items-center gap-2",children:[o,r,f]})}),e[9]=o,e[10]=r,e[11]=f,e[12]=c):c=e[12],c}function Gt({conflict:t,canEdit:e,onActionSuccess:n,coalitionOneName:i,coalitionTwoName:l,openAddAllianceDialog:o,openAddAllForNationDialog:r,allianceRemoveAction:f}){const{data:c,isFetching:a,isError:j,error:S}=Ke(We(it.endpoint,{conflicts:String(t.id)})),[I,v]=D.useState(null),g=c?.data??void 0,N=D.useMemo(()=>g?.alliance_names??{},[g?.alliance_names]),E=D.useMemo(()=>g?.conflict_alliances?.[String(t.id)],[t.id,g?.conflict_alliances]),b=D.useMemo(()=>Ut(E),[E]),A=D.useMemo(()=>{const u=new Map;for(const m of b){const p=u.get(m.coalition)??[];p.push(m),u.set(m.coalition,p)}return u},[b]),C=D.useMemo(()=>[0,1].map(u=>({coalition:u,entries:A.get(u)??[]})),[A]),h=D.useCallback(()=>{v(null),n()},[n]),w=D.useMemo(()=>{const u=new Map;for(const m of b){const p=`${m.coalition}-${m.allianceId}`;u.set(p,()=>v(p))}return u},[b]),d=D.useCallback(()=>{v(null)},[]);return s.jsxs("div",{className:"mt-4 border-t border-border pt-4",children:[s.jsx("h3",{className:"text-sm font-semibold mb-2",children:"Alliances"}),j&&s.jsxs("div",{className:"mb-2 rounded border border-destructive/30 bg-destructive/10 px-2 py-1 text-xs text-destructive",children:["Failed to load alliances: ",String(S)]}),a&&s.jsx("div",{className:"mb-2 text-xs text-muted-foreground",children:"Loading alliances..."}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx(K,{variant:"outline",size:"sm",onClick:o,disabled:!e||!o,children:"Add Alliance"}),s.jsx(K,{variant:"outline",size:"sm",onClick:r,disabled:!e||!r,children:"Add All for Nation"})]}),s.jsxs("div",{className:"mb-2",children:[b.length===0&&!a&&s.jsx("div",{className:"text-xs text-muted-foreground py-1",children:"No alliances added."}),s.jsx("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:C.map(({coalition:u,entries:m})=>s.jsxs("div",{className:"rounded border border-border px-2 py-1",children:[s.jsxs("div",{className:"text-[11px] font-medium text-muted-foreground mb-1",children:[Qt(u,i,l)," (",m.length,")"]}),s.jsx("div",{className:"space-y-1",children:m.slice().sort((p,R)=>{const x=N[p.allianceId]||`Alliance ${p.allianceId}`,_=N[R.allianceId]||`Alliance ${R.allianceId}`;return x.localeCompare(_)}).map(p=>{const R=N[p.allianceId]||`Alliance ${p.allianceId}`,x=`${p.coalition}-${p.allianceId}`,_=I===x,q=Ht(t.id,p.allianceId);return s.jsxs("div",{className:"flex items-start gap-2 rounded px-1 py-1 hover:bg-muted",children:[s.jsx("div",{className:"min-w-0 flex-1 text-xs truncate",children:R}),!_&&s.jsx(K,{variant:"destructive",size:"sm",className:"h-6 px-2 text-[11px]",onClick:w.get(x),disabled:!e||!f,children:"Remove"}),_&&f&&s.jsxs("div",{className:"flex items-start gap-1",children:[s.jsx(je,{command:f.command,args:q,label:"Confirm?",classes:"!m-0 !h-6 !px-2 !w-auto",disabled:!e,onSuccess:h,showResultDialog:!0}),s.jsx(K,{variant:"outline",size:"sm",className:"h-6 px-2 text-[11px]",onClick:d,children:"Cancel"})]})]},x)})})]},`coalition-${u}`))})]})]})}function Jt(t){const e=G.c(25),{row:n,rowLabel:i,selectedIds:l,actions:o,canRunAction:r,canEdit:f,onActionSuccess:c,columnsInfo:a,getColumnsInfo:j}=t,{showDialog:S}=Ae();let I,v;if(e[0]!==o||e[1]!==n||e[2]!==l){let d;e[4]!==n||e[5]!==l?(d=u=>Et(u,{row:n,selectedIds:l}),e[4]=n,e[5]=l,e[6]=d):d=e[6],v=o.filter(d),e[0]=o,e[1]=n,e[2]=l,e[3]=v}else v=e[3];I=v;const g=I;let N;e[7]!==c?(N=()=>{c?.("")},e[7]=c,e[8]=N):N=e[8];const E=N;let b;e[9]!==a||e[10]!==j?(b=()=>{const d=j?.();return d&&d.length>0?d:a},e[9]=a,e[10]=j,e[11]=b):b=e[11];const A=b;let C;e[12]!==f||e[13]!==r||e[14]!==c||e[15]!==E||e[16]!==A||e[17]!==n||e[18]!==l||e[19]!==S||e[20]!==g?(C=()=>{const d=A(),u={category:de(n,"category",d),start:de(n,"start",d),end:de(n,"end",d),c1Name:de(n,"c1Name",d),c2Name:de(n,"c2Name",d)},m=y=>{const O=Ft(y,{row:n,selectedIds:l,formatted:u,columnsInfo:d}),z={row:n,selectedIds:l};S(y.label,O.renderDialog?O.renderDialog(z):s.jsx(Ve,{action:O,context:z,onSuccess:c}),{openInNewTab:!0,focusNewTab:!0,replaceActive:!1})},p=new Map,R=new Map;for(const y of g)p.set(y.id,()=>m(y)),R.set(y.id,c?()=>c(y.id):void 0);const x=Pt(g,{row:n,formatted:u,columnsInfo:d}),_=Lt(g),q=Vt(g),U=zt(g),L=Wt(g),J=Kt(g),V=new Map;for(const y of x){if(!y.action){V.set(y.key,void 0);continue}V.set(y.key,p.get(y.action.id))}const H=s.jsxs("div",{className:"space-y-3 pr-1",children:[s.jsx("div",{className:"flex items-start justify-end gap-2",children:_&&s.jsx(K,{variant:"outline",size:"sm",onClick:p.get(_.id),disabled:!r(_),className:"shrink-0",children:"Sync"})}),s.jsx("div",{className:"grid grid-cols-1 gap-1",children:x.map(y=>s.jsx(Yt,{field:y,openAction:V.get(y.key),canRun:y.action?r(y.action):!0},y.key))}),s.jsx("div",{className:"flex flex-wrap gap-1",children:q.map(y=>{const O=!r(y);return y.requiresDialog?s.jsx(K,{variant:y.detailRole==="danger"?"destructive":"outline",size:"sm",onClick:p.get(y.id),disabled:O,className:"mr-1 mb-1",children:y.label},y.id):s.jsx("div",{className:"mb-1",children:s.jsx(je,{command:y.command,args:y.buildArgs({row:n,selectedIds:l}),label:y.label,classes:"!ms-0",disabled:O,showResultDialog:!0,onSuccess:R.get(y.id)})},y.id)})}),s.jsx(Gt,{conflict:n,canEdit:f,onActionSuccess:E,coalitionOneName:ue(u.c1Name)??n.c1Name,coalitionTwoName:ue(u.c2Name)??n.c2Name,openAddAllianceDialog:U?p.get(U.id):void 0,openAddAllForNationDialog:L?p.get(L.id):void 0,allianceRemoveAction:J})]});S(`Conflict: ${n.name}`,H,{openInNewTab:!0,focusNewTab:!0,replaceActive:!1})},e[12]=f,e[13]=r,e[14]=c,e[15]=E,e[16]=A,e[17]=n,e[18]=l,e[19]=S,e[20]=g,e[21]=C):C=e[21];const h=C;let w;return e[22]!==h||e[23]!==i?(w=s.jsx(K,{variant:"outline",size:"sm",className:"max-w-[220px] truncate justify-start",onClick:h,children:i}),e[22]=h,e[23]=i,e[24]=w):w=e[24],w}const Xt=we.join(" "),Zt=M.join(" ");function en(t){const e=G.c(11),{id:n,rowIdx:i,rowNumber:l,selected:o,onToggle:r}=t;let f;e[0]!==n||e[1]!==r||e[2]!==i?(f=(I,v)=>{r(n,i,v)},e[0]=n,e[1]=r,e[2]=i,e[3]=f):f=e[3];const c=f,a=o?`Deselect conflict ${n}`:`Select conflict ${n}`,j=`conflict-select-${n}`;let S;return e[4]!==n||e[5]!==c||e[6]!==l||e[7]!==o||e[8]!==a||e[9]!==j?(S=s.jsx(Rt,{id:n,isSelected:o,onToggle:c,label:a,debugTag:j,rowNumber:l}),e[4]=n,e[5]=c,e[6]=l,e[7]=o,e[8]=a,e[9]=j,e[10]=S):S=e[10],S}function Dn(){const t=G.c(68),e=Ze(),{session:n}=tt();let i;t[0]===Symbol.for("react.memo_cache_sentinel")?(i={showDialogOnError:!1},t[0]=i):i=t[0];const{permission:l,error:o}=ze(we,i);let r;t[1]===Symbol.for("react.memo_cache_sentinel")?(r={showDialogOnError:!1},t[1]=r):r=t[1];const{permission:f,error:c}=ze(M,r),a=kt(),[j,S]=D.useState(0);let I;t[2]===Symbol.for("react.memo_cache_sentinel")?(I=[],t[2]=I):I=t[2];const v=D.useRef(I);let g;t[3]===Symbol.for("react.memo_cache_sentinel")?(g=[],t[3]=g):g=t[3];const[N,E]=D.useState(g),[b,A]=D.useState(null),C=!!l?.success,h=!!f?.success;let w;t[4]!==e?(w=async()=>{await e.invalidateQueries({queryKey:[lt.endpoint.name]}),S(on)},t[4]=e,t[5]=w):w=t[5];const d=w;let u;t[6]!==d?(u=async()=>{await d()},t[6]=d,t[7]=u):u=t[7];const m=u;let p;t[8]===Symbol.for("react.memo_cache_sentinel")?(p=T=>{v.current=T},t[8]=p):p=t[8];const R=p;let x;t[9]===Symbol.for("react.memo_cache_sentinel")?(x=()=>v.current,t[9]=x):x=t[9];const _=x;let q;t[10]===Symbol.for("react.memo_cache_sentinel")?(q=T=>{const W=T.map(ln).filter(sn);E(W)},t[10]=q):q=t[10];const U=q;let L;t[11]!==b||t[12]!==N||t[13]!==a?(L=(T,W,$e)=>{const ae=!a.has(T);if($e&&b!==null&&N.length>0){const ce=Math.max(0,Math.min(b,W)),Je=Math.min(N.length-1,Math.max(b,W)),Le=N.slice(ce,Je+1);ae?a.addMany(Le):a.removeMany(Le),A(W);return}a.setOne(T,ae),A(W)},t[11]=b,t[12]=N,t[13]=a,t[14]=L):L=t[14];const J=L;let V;t[15]!==N||t[16]!==a?(V=()=>{a.addMany(N)},t[15]=N,t[16]=a,t[17]=V):V=t[17];const H=V;let y;t[18]!==h||t[19]!==C?(y=T=>{if(!T)return!0;const W=T.join(" ");return W===Xt?C:W===Zt?h:!1},t[18]=h,t[19]=C,t[20]=y):y=t[20];const O=y;let z;t[21]!==O?(z=T=>O(T.permission),t[21]=O,t[22]=z):z=t[22];const Q=z;let Z,Y;t[23]===Symbol.for("react.memo_cache_sentinel")?(Y=qt(),t[23]=Y):Y=t[23],Z=Y;const X=Z;let me,fe;t[24]===Symbol.for("react.memo_cache_sentinel")?(fe=Bt(),t[24]=fe):fe=t[24],me=fe;const Ge=me;let Fe,pe;t[25]!==h||t[26]!==Q||t[27]!==m||t[28]!==a.selectedIds?(pe={id:"actions",title:"Conflict",position:"start",hideOnMobile:!1,sortable:!1,exportable:!1,editable:!1,draggable:!1,value:nn,render:{display:T=>!Mt(T)||T.id<0?"-":s.jsx("div",{className:"flex items-center gap-1 justify-end sm:justify-start",children:s.jsx(Jt,{row:T,rowLabel:T.name,selectedIds:a.selectedIds,actions:Ge,canRunAction:Q,canEdit:h,onActionSuccess:m,getColumnsInfo:_})})}},t[25]=h,t[26]=Q,t[27]=m,t[28]=a.selectedIds,t[29]=pe):pe=t[29];const Re=pe;let ge;t[30]!==Re?(ge=[Re],t[30]=Re,t[31]=ge):ge=t[31],Fe=ge;const ke=Fe;let be;t[32]!==J||t[33]!==a?(be=T=>{const{row:W,rowIdx:$e,rowNumber:ae}=T,ce=Me(P(W,"id"));return ce===null?String(ae):s.jsx(en,{id:ce,rowIdx:$e,rowNumber:ae,selected:a.has(ce),onToggle:J})},t[32]=J,t[33]=a,t[34]=be):be=t[34];const Ie=be;let he;t[35]!==a?(he=T=>{const W=Me(P(T,"id"));if(W)return a.has(W)?"bg-blue-100/80 dark:bg-blue-900/30":void 0},t[35]=a,t[36]=he):he=t[36];const Ee=he;let Pe,ee;t[37]!==c||t[38]!==o?(ee=[],o&&ee.push(`Sync permission unavailable: ${o}`),c&&ee.push(`Edit permission unavailable: ${c}`),t[37]=c,t[38]=o,t[39]=ee):ee=t[39],Pe=ee;const xe=Pe,ye=!!(n?.user_valid||n?.nation_valid||n?.registered);let te;t[40]!==ye||t[41]!==xe?(te=(xe.length>0||!ye)&&s.jsxs("div",{className:"mb-2 rounded border border-amber-400/50 bg-amber-500/10 px-3 py-2 text-sm",children:[!ye&&s.jsxs("div",{className:"mb-1",children:["You are not logged in. Some actions are disabled. ",s.jsx(et,{to:"/login",className:"underline",children:"Login"})]}),xe.map(tn)]}),t[40]=ye,t[41]=xe,t[42]=te):te=t[42];let ne;t[43]!==Q||t[44]!==m||t[45]!==a.selectedIds?(ne=s.jsx(jt,{title:"Conflicts",selectedIds:a.selectedIds,actions:X,canRunAction:Q,onActionSuccess:m,actionLayout:"stacked"}),t[43]=Q,t[44]=m,t[45]=a.selectedIds,t[46]=ne):ne=t[46];const De=N.length===0;let se;t[47]!==H||t[48]!==De?(se=s.jsx(K,{variant:"outline",size:"sm",onClick:H,disabled:De,children:"Select visible"}),t[47]=H,t[48]=De,t[49]=se):se=t[49];const _e=a.count===0;let ie;t[50]!==a.clear||t[51]!==_e?(ie=s.jsx(K,{variant:"outline",size:"sm",onClick:a.clear,disabled:_e,children:"Clear selected"}),t[50]=a.clear,t[51]=_e,t[52]=ie):ie=t[52];let le;t[53]!==se||t[54]!==ie?(le=s.jsxs("div",{className:"mb-2 flex flex-wrap items-center gap-2",children:[se,ie]}),t[53]=se,t[54]=ie,t[55]=le):le=t[55];const Te=`conflicts-${j}`;let Ce,Se;t[56]===Symbol.for("react.memo_cache_sentinel")?(Ce={"":"*"},Se=Dt.aliasedArray(),t[56]=Ce,t[57]=Se):(Ce=t[56],Se=t[57]);let oe;t[58]!==ke||t[59]!==Ie||t[60]!==Ee||t[61]!==Te?(oe=s.jsx(gt,{type:"Conflict",selection:Ce,columns:Se,columnRenderers:Tt,clientColumns:ke,rowClassName:Ee,indexCellRenderer:Ie,indexColumnWidth:64,onColumnsLoaded:R,onRowsRendered:U},Te),t[58]=ke,t[59]=Ie,t[60]=Ee,t[61]=Te,t[62]=oe):oe=t[62];let Ne;return t[63]!==te||t[64]!==ne||t[65]!==le||t[66]!==oe?(Ne=s.jsxs(s.Fragment,{children:[te,ne,le,oe]}),t[63]=te,t[64]=ne,t[65]=le,t[66]=oe,t[67]=Ne):Ne=t[67],Ne}function tn(t){return s.jsx("div",{className:"text-amber-900 dark:text-amber-200",children:t},t)}function nn(t){return $t(t)}function sn(t){return t!==null}function ln(t){return Me(P(t,"id"))}function on(t){return t+1}export{Dn as default};
